name: Windows NoVNC
on:
  workflow_dispatch:
concurrency:
  group: vps-${{ github.repository }}
  cancel-in-progress: true
jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 55
    steps:
    - uses: actions/checkout@v4
    - name: Install Software
      shell: cmd
      run: choco install googlechrome 7zip -y --no-progress --ignore-checksums
    - name: Set Password
      shell: pwsh
      run: |
        $pw = ConvertTo-SecureString "Vps@j2hYNgtz0" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $pw
        Write-Host "Password set successfully"
    - name: Install TightVNC
      shell: cmd
      run: |
        echo Downloading TightVNC...
        curl -L -o vnc.msi https://www.tightvnc.com/download/2.8.63/tightvnc-2.8.63-gpl-setup-64bit.msi
        echo Installing TightVNC...
        msiexec /i vnc.msi /quiet /norestart ADDLOCAL=Server SERVER_REGISTER_AS_SERVICE=1 SERVER_ADD_FIREWALL_EXCEPTION=1 SET_USEVNCAUTHENTICATION=1 VALUE_OF_USEVNCAUTHENTICATION=1 SET_PASSWORD=1 VALUE_OF_PASSWORD=Vps@j2hYNgtz0 SET_ALLOWLOOPBACK=1 VALUE_OF_ALLOWLOOPBACK=1
        timeout /t 15 /nobreak
        net stop tvnserver
        timeout /t 3 /nobreak
        net start tvnserver
        timeout /t 5 /nobreak
    - name: Setup Websockify
      shell: pwsh
      run: |
        pip install websockify -q
        Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/tags/v1.5.0.zip" -OutFile "novnc.zip" -UseBasicParsing
        Expand-Archive novnc.zip -DestinationPath . -Force
        if (Test-Path "noVNC-1.5.0") { Rename-Item "noVNC-1.5.0" "noVNC" -Force }
        Start-Process python -ArgumentList "-m","websockify","--web","noVNC","6080","127.0.0.1:5900" -WindowStyle Hidden
        Start-Sleep -Seconds 5
    - name: Start Tunnel
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cf.exe" -UseBasicParsing
        Start-Process .\cf.exe -ArgumentList "tunnel","--url","http://localhost:6080","--logfile","cf.log" -WindowStyle Hidden
        Start-Sleep -Seconds 45
        $url = ""
        for ($i = 0; $i -lt 30; $i++) {
          if (Test-Path cf.log) {
            $content = Get-Content cf.log -Raw -ErrorAction SilentlyContinue
            $match = [regex]::Match($content, 'https://[a-zA-Z0-9-]+\.trycloudflare\.com')
            if ($match.Success) {
              $url = $match.Value
              break
            }
          }
          Start-Sleep 2
        }
        if ($url) {
          "$url/vnc.html|Vps@j2hYNgtz0" | Out-File info.txt -NoNewline -Encoding UTF8
        } else {
          "ERROR|Tunnel not found" | Out-File info.txt -NoNewline -Encoding UTF8
        }
    - uses: actions/upload-artifact@v4
      with:
        name: result
        path: info.txt
    - name: Keep Alive
      shell: pwsh
      run: Start-Sleep -Seconds (30 * 60)